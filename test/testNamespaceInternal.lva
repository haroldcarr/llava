;;;;
;;;; Created       : 2000 Oct 21 (Sat) 10:46:48 by Harold Carr.  
;;;; Last Modified : 2004 Dec 22 (Wed) 10:37:38 by Harold Carr.
;;;;

;; This tests NamespaceImpl independently  of it being installed
;; as the Lava top level environment.  It also tests even when
;; it is installed.

(_comment

(load "testNamespace.lva")
(doTest "testNamespace.lva")

(load "testLava/testNamespace.lva")
(doTest "testLava/testNamespace.lva")

(importX 'testNamespace.one.One)

;; built-in
(min 5 2 8)
(max 5 2 8)
(import testNamespace.one.OneI)
(min 5 2 8)
(max 5 2 8)
(package testNamespace.two TwoI)
(min 5 2 8)
(max 5 2 8)
(package lava Lava)
(min 5 2 8)
(max 5 2 8)

(require 'java/lang/import)
(import java.util.Hashtable)
(import java.lang.Float)
(valueOf "45.5")
(parseFloat "45.5")
)

(require 'test/test)

(define packageX 
  (lambda (p c)
    (_package *ns* p c)))

(define importX
  (lambda (name)
    (_import *ns* name)))

(define setE!
  (lambda (var val)
    (set *ns* var val)))

(define refE
  (lambda (var)
    (get *ns* var)))

;; Do not really do it.
(define _%importAux (lambda args (_println (cons '_%importAux args))))

(define (initTest)

  (let* ((evaluator   (_si 'newEvaluator 'libLava.rt.FR))
	 (compiler    (_si 'newCompiler  'libLava.co.FC))
	 (environment (newEnvironmentTopLevel
		       (new 'libLava.r1.env.NamespaceImpl)))
	 (runtime     (_si 'newLavaRuntime 'libLava.rt.FR 
			   environment evaluator))
	 (err         (new 'java.io.PrintWriter  (_sf 'err 'java.lang.System)))
	 (repl        (_si 'newRepl 'lava.F
			   (_si 'newLavaReader 'lava.F
				(new 'java.io.InputStreamReader
				     (_sf 'in 'java.lang.System)))
			   (new 'java.io.PrintWriter 
				(_sf 'out 'java.lang.System))
			   err
			   runtime
			   compiler))
	 (tlInit      (_si 'newEnvTopLevelInit 'libLava.rt.FR repl)))

    (init tlInit)
    (loadDerived tlInit)
    (setUndefinedIdHandler environment
			   (_si 'newUndefinedIdHandler 'libLava.rt.FR))

    (define *ns* environment)
		
    (setE! 'packageX packageX)
    (setE! 'importX importX)
    (setE! 'setE! setE!)
    (setE! 'refE refE)
    (setE! '_%importAux _%importAux)

    (let ((replNs (createNamespace *ns* "lava.REPL" 
				   (_f 'classVariables *ns*))))
      (setCurrentNamespace *ns* replNs))

    (define (userHome) (_si 'getProperty 'java.lang.System "user.home"))

    *ns*))

(define (extractMessage throwable)
  (if (instanceof throwable 'lava.lang.exceptions.LavaException)
      (getMessage (getThrowable throwable))
      (getMessage throwable)))

(define (doTest . args)
  (if (not (null? args))
      (load (car args)))
  (testNamespaceFoundation)
  (testNamespacePackage)
  (testNamespaceImport)
  (testNamespaceRefSet)
  (testNamespaceNew)
  )

;;;;
;;;; Test foundation.
;;;;

(define (testNamespaceFoundation)

  (initTest)

  (begin-test)

  (check 1
	 '("lava.Lava")
	 (getRefListNames (getRootNamespace *ns*)))
  (check 1
	 '("lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  
  (createNamespace *ns* "foo.bar" (_f 'classVariables *ns*))
  (check 2 
	 '("foo.bar" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  
  (findOrCreateNamespace *ns* "foo.bar")
  (check 3
	 '("foo.bar" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  
  (check 4
	 '("foo.bar" "lava.Lava")
	 (getRefListNames (findNamespace *ns* "foo.bar")))
  
  (findOrCreateNamespace *ns* "bar.baz")
  (check 5
	 '("bar.baz" "foo.bar" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  
  (check 6
	 '("bar.baz" "lava.Lava")
	 (getRefListNames (findOrCreateNamespace *ns* "bar.baz")))
  
  (end-test 'testNamespaceFoundation))

;-------------------------

;;;;
;;;; Test "package".
;;;;

(define (testNamespacePackage)

  (initTest)

  (begin-test)

  (check 1
	 '("lava.REPL" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  
  (packageX 'foo 'bar)
  (check 2 '("foo.bar" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 3 '("foo.bar" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  
  (packageX 'foo 'bar)
  (check 2 '("foo.bar" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 3 '("foo.bar" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  
  (packageX 'foo 'baz)
  (check 2 '("foo.bar" "foo.baz" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 2  '("foo.baz" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  
  (packageX 'buz 'saw)
  (check 2 '("buz.saw" "foo.bar" "foo.baz" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  
  (check 1
	 '("buz.saw" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  
  (packageX (string->symbol "") 'Only)
  (check 1 '(".Only" "buz.saw" "foo.bar" "foo.baz" "lava.Lava" "lava.REPL")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 1
	 '(".Only" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  
  (end-test 'testNamespacePackage))

;-------------------------

;;;;
;;;; Test "import".
;;;;

(define (testNamespaceImport)

  (initTest)

  (begin-test)

  (check 1 '("lava.Lava" "lava.REPL") (getFullNameNamespaceMapKeys *ns*))
  (check 2 '("lava.REPL" "lava.Lava") 
	 (getRefListNames (getCurrentNamespace *ns*)))

  (check 1 (string-append "(re)load: " (userHome)
			  "/.sync/.lsync/lava/testLava/testNamespace/one/One.lva")
	 (importX 'testNamespace.one.One))
  (check 2 (string-append "no change: " (userHome) 
			  "/.sync/.lsync/lava/testLava/testNamespace/one/One.lva")
	 (importX 'testNamespace.one.One))
  (check 3 '("lava.Lava" "lava.REPL"
	     "testNamespace.one.One" "testNamespace.two.Two")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 4
	 '("lava.REPL" "testNamespace.one.One" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  (check 5
	 '("testNamespace.one.One" "testNamespace.two.Two" "lava.Lava")
	 (getRefListNames (findNamespace *ns* "testNamespace.one.One")))
  (check 6
	 '("testNamespace.two.Two" "lava.Lava")
	 (getRefListNames (findNamespace *ns* "testNamespace.two.Two")))

  (check 6 (string-append "no change: " (userHome) 
			  "/.sync/.lsync/lava/testLava/testNamespace/two/Two.lva")
	 (importX 'testNamespace.two.Two))
  (check 6 '("lava.Lava" "lava.REPL"
	     "testNamespace.one.One" "testNamespace.two.Two")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 7 '("lava.REPL" "testNamespace.one.One"
	     "testNamespace.two.Two" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))

  (check 6 (string-append "no change: " (userHome)
			  "/.sync/.lsync/lava/testLava/testNamespace/two/Two.lva")
	 (importX 'testNamespace.two.Two))
  (check 8 '("lava.REPL" "testNamespace.one.One"
	     "testNamespace.two.Two" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))

  (check 9 "class java.util.Hashtable"
	 (importX 'java.util.Hashtable))

  (check 9 "already loaded: class java.util.Hashtable"
	 (importX 'java.util.Hashtable))

  (end-test 'testNamespaceImport))

;-------------------------

;;;;
;;;; Test ref/set
;;;;

(define (testNamespaceRefSet)

  (initTest)

  (begin-test)

  (packageX 'lava 'Lava)
  (check 0 '("lava.Lava") (getRefListNames (getCurrentNamespace *ns*)))
  (setE! 'a 'Lava-a)
  (check 0 'Lava-a (refE 'a))
  (check 0 'Lava-a (refE '.a))
  (check 0 'Lava-a (refE 'Lava.a))
  (check 0 'Lava-a (refE 'lava.Lava.a))

  (packageX 'lava 'REPL)
  (check 0 "lava.REPL" (getName (getCurrentNamespace *ns*)))
  (check 0 '("lava.REPL" "lava.Lava") 
	 (getRefListNames (getCurrentNamespace *ns*)))
  (check 0 'Lava-a (refE 'a))
  (check 1 'REPL-a (setE! 'a 'REPL-a))
  (check 2 'REPL-a (refE 'a))
  (check 2 'Lava-a (refE '.a))
  (check 2 'Lava-a (refE 'Lava.a))
  (check 2 'REPL-a (refE 'REPL.a))
  (check 2 'Lava-a (refE 'Lava.a))
  (check 2 'REPL-a (refE 'lava.REPL.a))
  (check 2 'Lava-a (refE 'lava.Lava.a))

  (packageX 'foo.bar 'Baz)
  (check 3 '("foo.bar.Baz" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  (check 3 'Lava-a (refE 'a))
  (setE! 'a 'Baz-a)
  (check 2 'Baz-a (refE 'a))
  (check 2 'Baz-a (refE 'Baz.a))
  (check 2 'Lava-a (refE '.a))
  (check 2 'Lava-a (refE 'Lava.a))
  (check 2 'Baz-a (refE 'foo.bar.Baz.a))
  (check 2 'Lava-a (refE 'lava.Lava.a))
  (check 2
	 "Undefined top level variable: REPL.a"
	 (try (refE 'REPL.a) 
	      (catch (java.lang.Throwable e) (extractMessage e))))
  (check 2
	 "Undefined top level variable: lava.REPL.a"
	 (try (refE 'lava.REPL.a) 
	      (catch (java.lang.Throwable e) (extractMessage e))))

  (importX 'testNamespace.one.One)
  (check 3
	 '("foo.bar.Baz" "testNamespace.one.One" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  (check 4 'Baz-a (refE 'a))
  (check 4 'Lava-a (refE 'Lava.a))
  (check 4 'Lava-a (refE '.a))

  (packageX 'testNamespace.one 'One)
  (check 4 "testNamespace.one.One" (getName (getCurrentNamespace *ns*)))
  (check 4 'Lava-a (refE 'a))
  (check 4 'Lava-a (refE '.a))
  (setE! 'a 'One-a)

  (packageX 'foo.bar 'Baz)
  (check 4 "foo.bar.Baz" (getName (getCurrentNamespace *ns*)))
  (check 3
	 '("foo.bar.Baz" "testNamespace.one.One" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  (check 0 'Baz-a (refE 'a))
  (check 0 'Lava-a (refE '.a))
  (check 4 'Baz-a (refE 'a))
  (check 0 'One-a (refE 'One.a))
  (check 0 'Lava-a (refE 'Lava.a))
  (check 0 'One-a (refE 'testNamespace.one.One.a))

  (packageX 'lava 'Lava)
  (check 0 '("lava.Lava") (getRefListNames (getCurrentNamespace *ns*)))
  (check 0 'Lava-a (refE 'a))
  (check 0 'Lava-a (refE '.a))
  (check 0 'Lava-a (refE 'lava.Lava.a))
  (check 2
	 "Undefined top level variable: One.a"
	 (try (refE 'One.a) 
	      (catch (java.lang.Throwable e) (extractMessage e))))
  (check 2
	 "Undefined top level variable: testNamespace.one.One.a"
	 (try (refE 'testNamespace.one.One.a) 
	      (catch (java.lang.Throwable e) (extractMessage e))))

  (packageX (string->symbol "") 'Only)
  (setE! 'a 'Only-a)
  (check 0 'Only-a (refE 'a))
  (check 0 'Only-a (refE 'Only.a))
  ;;(check 0 'Lava-a (refE '.a))

  (end-test 'testNamespaceRefSet))

;-------------------------

;;;;
;;;; Test new.
;;;;

(define (testNamespaceNew)

  (initTest)

  (begin-test)

  (check 0 "java.util.Hashtable" 
	 (getFullNameForClass *ns* 'java.util.Hashtable))
  (check 1 "getFullNameForClass: undefined: Hashtable"
	 (try (getFullNameForClass *ns* 'Hashtable)
	      (catch (java.lang.Throwable e) (extractMessage e))))
  (importX 'java.util.Hashtable)
  (check 3 "java.util.Hashtable" (getFullNameForClass *ns* 'Hashtable))
  
  (end-test 'testNamespaceNew))

;;;;
;;;; do the test when loaded.
;;;;

(doTest)

;;; End of file.
