;;;;
;;;; Created       : 2000 Oct 21 (Sat) 10:46:48 by Harold Carr.  
;;;; Last Modified : 2004 Dec 22 (Wed) 10:37:38 by Harold Carr.
;;;;

(_comment
(begin
(package x bottom)
(define bottom 
  (lambda (x) 
    (let ((x (+ x 1)))
      (list 'bottom x))))

(package x top)
(import x.bottom)
;; If defined this way then bottom does not get found
;; because let expands to lambda which is created in the Repl package.
(define top 
  (lambda (x) 
    (let ((x (+ x 1)))
      (list 'top (bottom x)))))
;; If defined this way it works because no let/lambda creation.
(_comment
(define top 
  (lambda (x) 
      (list 'top (bottom x))))
)

(package lava Repl)
(import x.top)
(top 1)
)
)

(require 'test/test)

(define (doTest . args)
  (if (not (null? args))
      (load (car args)))
  (testNamespaceFoundation)
  (testNamespacePackage)
  (testNamespaceImport)
  (testNamespaceRefSet)
  (testNamespaceNew)
  )

(define (extractMessage throwable)
  (if (instanceof throwable 'lava.lang.exceptions.LavaException)
      (getMessage (getThrowable throwable))
      (getMessage throwable)))

(define (initTest)
  (let* ((newLava (new 'lavaProfile.Lava))
	 (newEnv  (getEnvironmentTopLevel newLava)))

    (define (userHome) (_si 'getProperty 'java.lang.System "user.home"))

    ;; This is used to test everything independently of the built
    ;; in namespace.
    (set! *newNs* (findNamespace newEnv "lava.Repl"))
    (setIsSealed (findNamespace newEnv "lava.Lava") false)
    (setUndefinedIdHandler newEnv (_si 'newUndefinedIdHandler 'lavaProfile.runtime.FR))

    ;; This one is used for import testing.
    (set! *ns* (package lava Repl))))

;;;;
;;;; Test foundation.
;;;;

(define (testNamespaceFoundation)

  (initTest)

  (begin-test)

  (check 1
	 '("lava.Lava")
	 (getRefListNames (getRootNamespace *newNs*)))
  (check 1
	 '("lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  
  (createNamespace *newNs* "foo.bar" (_f 'classVariables *newNs*))
  (check 2 
	 '("foo.bar" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  
  (findOrCreateNamespace *newNs* "foo.bar")
  (check 3
	 '("foo.bar" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  
  (check 4
	 '("foo.bar" "lava.Lava")
	 (getRefListNames (findNamespace *newNs* "foo.bar")))
  
  (findOrCreateNamespace *newNs* "bar.baz")
  (check 5
	 '("bar.baz" "foo.bar" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  
  (check 6
	 '("bar.baz" "lava.Lava")
	 (getRefListNames (findOrCreateNamespace *newNs* "bar.baz")))
  
  (end-test 'testNamespaceFoundation))

;-------------------------

;;;;
;;;; Test "package".
;;;;

(define (testNamespacePackage)

  (initTest)

  (begin-test)

  (check 1
	 '("lava.Repl" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  
  (_package *newNs* 'foo 'bar)
  (check 2 '("foo.bar" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  (check 3 '("foo.bar" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  
  (_package *newNs* 'foo 'bar)
  (check 2 '("foo.bar" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  (check 3 '("foo.bar" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  
  (_package *newNs* 'foo 'baz)
  (check 2 '("foo.bar" "foo.baz" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  (check 2  '("foo.baz" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  
  (_package *newNs* 'buz 'saw)
  (check 2 '("buz.saw" "foo.bar" "foo.baz" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  
  (check 1
	 '("buz.saw" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  
  (_package *newNs* (string->symbol "") 'Only)
  (check 1 '(".Only" "buz.saw" "foo.bar" "foo.baz" "lava.Lava" "lava.Repl")
	 (getFullNameNamespaceMapKeys *newNs*))
  (check 1
	 '(".Only" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  
  (end-test 'testNamespacePackage))

;-------------------------

;;;;
;;;; Test "import".
;;;;

(define (testNamespaceImport)

  (initTest)

  (begin-test)

  (check 1 '("lava.Lava" "lava.Repl") (getFullNameNamespaceMapKeys *ns*))
  (check 2 '("lava.Repl" "lava.Lava") 
	 (getRefListNames (getCurrentNamespace *ns*)))

  (check 1 (string-append "(re)load: " (userHome)
			  "/.sync/.lsync/lava/testLava/testNamespace/one/OneI.lva")
	 (import testNamespace.one.OneI))
  (check 2 (string-append "no change: " (userHome) 
			  "/.sync/.lsync/lava/testLava/testNamespace/one/OneI.lva")
	 (import testNamespace.one.OneI))
  (check 3 '("lava.Lava" "lava.Repl"
	     "testNamespace.one.OneI" "testNamespace.two.TwoI")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 4
	 '("lava.Repl" "testNamespace.one.OneI" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))
  (check 5
	 '("testNamespace.one.OneI" "testNamespace.two.TwoI" "lava.Lava")
	 (getRefListNames (findNamespace *ns* "testNamespace.one.OneI")))
  (check 6
	 '("testNamespace.two.TwoI" "lava.Lava")
	 (getRefListNames (findNamespace *ns* "testNamespace.two.TwoI")))

  (check 6 (string-append "no change: " (userHome) 
			  "/.sync/.lsync/lava/testLava/testNamespace/two/TwoI.lva")
	 (import testNamespace.two.TwoI))
  (check 6 '("lava.Lava" "lava.Repl"
	     "testNamespace.one.OneI" "testNamespace.two.TwoI")
	 (getFullNameNamespaceMapKeys *ns*))
  (check 7 '("lava.Repl" "testNamespace.one.OneI"
	     "testNamespace.two.TwoI" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))

  (check 6 (string-append "no change: " (userHome)
			  "/.sync/.lsync/lava/testLava/testNamespace/two/TwoI.lva")
	 (import testNamespace.two.TwoI))
  (check 8 '("lava.Repl" "testNamespace.one.OneI"
	     "testNamespace.two.TwoI" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *ns*)))

  (check 9 "class java.util.StringTokenizer"
	 (import java.util.StringTokenizer))

  (check 9 "already loaded: class java.util.StringTokenizer"
	 (import java.util.StringTokenizer))

  (end-test 'testNamespaceImport))

;-------------------------

;;;;
;;;; Test ref/set
;;;;

(define (testNamespaceRefSet)

  (initTest)

  (begin-test)

  (set! *newNs* (_package *newNs* 'lava 'Lava))
  (check 0 '("lava.Lava") (getRefListNames (getCurrentNamespace *newNs*)))
  (set *newNs* 'a 'Lava-a)
  (check 0 'Lava-a (get *newNs* 'a))
  (check 0 'Lava-a (get *newNs* '.a))
  (check 0 'Lava-a (get *newNs* 'Lava.a))
  (check 0 'Lava-a (get *newNs* 'lava.Lava.a))

  (set! *newNs* (_package *newNs* 'lava 'Repl))
  (check 0 "lava.Repl" (getName (getCurrentNamespace *newNs*)))
  (check 0 '("lava.Repl" "lava.Lava") 
	 (getRefListNames (getCurrentNamespace *newNs*)))
  (check 0 'Lava-a (get *newNs* 'a))
  (check 1 'REPL-a (set *newNs* 'a 'REPL-a))
  (check 2 'REPL-a (get *newNs* 'a))
  (check 2 'Lava-a (get *newNs* '.a))
  (check 2 'Lava-a (get *newNs* 'Lava.a))
  (check 2 'REPL-a (get *newNs* 'Repl.a))
  (check 2 'Lava-a (get *newNs* 'Lava.a))
  (check 2 'REPL-a (get *newNs* 'lava.Repl.a))
  (check 2 'Lava-a (get *newNs* 'lava.Lava.a))

  (set! *newNs* (_package *newNs* 'foo.bar 'Baz))
  (check 3 '("foo.bar.Baz" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  (check 3 'Lava-a (get *newNs* 'a))
  (set *newNs* 'a 'Baz-a)
  (check 2 'Baz-a (get *newNs* 'a))
  (check 2 'Baz-a (get *newNs* 'Baz.a))
  (check 2 'Lava-a (get *newNs* '.a))
  (check 2 'Lava-a (get *newNs* 'Lava.a))
  (check 2 'Baz-a (get *newNs* 'foo.bar.Baz.a))
  (check 2 'Lava-a (get *newNs* 'lava.Lava.a))
  (check 2
	 "Undefined top level variable: Repl.a"
	 (try (get *newNs* 'Repl.a) 
	      (catch (java.lang.Throwable e) (extractMessage e))))
  ;; It is ok to reference long names from any package.
  ;; Necessary for macros to work between packages.
  (check 2 'REPL-a (get *newNs* 'lava.Repl.a))

  (set! *newNs* (_package *newNs* 'testNamespace.one 'One))
  (check 4 "testNamespace.one.One" (getName (getCurrentNamespace *newNs*)))
  (check 4 'Lava-a (get *newNs* 'a))
  (check 4 'Lava-a (get *newNs* '.a))
  (set *newNs* 'a 'One-a)

  (set! *newNs* (_package *newNs* 'foo.bar 'Baz))
  (check 4 "foo.bar.Baz" (getName (getCurrentNamespace *newNs*)))
  (check 3
	 '("foo.bar.Baz" "lava.Lava")
	 (getRefListNames (getCurrentNamespace *newNs*)))
  (check 0 'Baz-a (get *newNs* 'a))
  (check 0 'Lava-a (get *newNs* '.a))
  (check 4 'Baz-a (get *newNs* 'a))
  (check 0 'One-a (get *newNs* 'testNamespace.one.One.a))
  (check 0 'Lava-a (get *newNs* 'lava.Lava.a))
  (check 0 'One-a (get *newNs* 'testNamespace.one.One.a))

  (set! *newNs* (_package *newNs* 'lava 'Lava))
  (check 0 '("lava.Lava") (getRefListNames (getCurrentNamespace *newNs*)))
  (check 0 'Lava-a (get *newNs* 'a))
  (check 0 'Lava-a (get *newNs* '.a))
  (check 0 'Lava-a (get *newNs* 'lava.Lava.a))
  (check 2
	 "Undefined top level variable: One.a"
	 (try (get *newNs* 'One.a) 
	      (catch (java.lang.Throwable e) (extractMessage e))))
  (check 2 'One-a (get *newNs* 'testNamespace.one.One.a))

  (set! *newNs* (_package *newNs* (string->symbol "") 'Only))
  (set *newNs* 'a 'Only-a)
  (check 0 'Only-a (get *newNs* 'a))
  (check 0 'Only-a (get *newNs* '.Only.a))
  (check 0 'Lava-a (get *newNs* '.a))

  (end-test 'testNamespaceRefSet))

;-------------------------

;;;;
;;;; Test new.
;;;;

(define (testNamespaceNew)

  (initTest)

  (begin-test)

  (check 0 "java.util.Hashtable" 
	 (getFullNameForClass *ns* 'java.util.Hashtable))
  (check 1 "getFullNameForClass: undefined: Hashtable"
	 (try (getFullNameForClass *ns* 'Hashtable)
	      (catch (java.lang.Throwable e) (extractMessage e))))
  (import java.util.Hashtable)
  (check 3 "java.util.Hashtable" (getFullNameForClass *ns* 'Hashtable))
  
  (end-test 'testNamespaceNew))

;;;;
;;;; Test library.
;;;;

(define (testNamespaceLibrary)

  ;; This one cannot use the test procedures since they are written
  ;; with require and do not exist when we switch packages.

  (package testing.one two)
  
  (import cl.Control)
  (set! temp 0)
  (dotimes (i 4) (set! temp (+ temp i)))
  ;; REVISIT - cannot use check in different package.
  (if (not (= temp 6)) 
      (_println 'BAD))

  (if (not (equals "Undefined top level variable: gensym"
		   (try (gensym)
			(catch (java.lang.Throwable e) 
			       (getMessage e)))))
      (_println 'BAD))
  (if (not (symbol? (cl.Symbols.gensym)))
      (_println 'BAD))

  (define (dotimes a) a)
  (if (not (= (dotimes 4) 4))
      (_println 'BAD))
  (package cl Control)
  (set! temp 0)
  (dotimes (i 4) (set! temp (+ temp i)))
  (if (not (= temp 6)) 
      (_println 'BAD))
  (if (not (symbol? (gensym)))
      (_println 'BAD))

)

;;;;
;;;; do the test when loaded.
;;;;

(_comment
(load "testNamespaceInternal.lva")
)

(doTest)

;;; End of file.
